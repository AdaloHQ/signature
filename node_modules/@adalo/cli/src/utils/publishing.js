const fs = require('fs')
const path = require('path')
const validate = require('validate-npm-package-name')
const chalk = require('chalk')

const bytesToSize = (bytes) => {
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']
  if (bytes === 0) return 'n/a'
  const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)), 10)
  if (i === 0) return `${bytes} ${sizes[i]}`
  return `${(bytes / 1024 ** i).toFixed(1)} ${sizes[i]}`
}

/**
 * Formats name to @adalo-components/${npm-safe-name}
 * @param {*} name
 */
const formatName = (name) => {
  if (name.match(/[@/]/g)) {
    if (name.startsWith('@')) name = name.replace('@', '')
    if (name.includes('/')) name = name.replace('/', '-')
  }

  // prefix with npm organization
  name = `@adalo-components/${name}`

  return name
}

/**
 * Validate package.json
 * @param {Object} pkg
 */
const validatePackage = (pkg, opts) => {
  let errors = []

  if (!pkg) throw new Error('Missing package.json')

  console.log('  Validating package.json configuration')

  if (pkg.proton) {
    console.warn('')
    console.warn(
      chalk.bold.yellow(
        `  warning: using legacy library package.json property "proton"`
      )
    )
  }

  if (!pkg.name) {
    errors.push('Missing package "name" property in package.json.')
  }

  if (!validate(pkg.name)) {
    errors.push('Invalid package name.')
  }

  if (!pkg.main) {
    errors.push('Missing "main" property in package.json.')
  } else if (!fs.existsSync(path.join(process.cwd(), pkg.main))) {
    errors.push('Package main path is invalid or does not exist.')
  }

  if (!pkg.version) {
    errors.push('Missing "version" property in package.json.')
  }

  if (!pkg.author) {
    errors.push('Missing "author" property in package.json.')
  }

  if (!pkg.description) {
    errors.push('Missing "description" property in package.json.')
  }

  const libraryProp = pkg.adalo || pkg.proton

  // validate library property
  if (!libraryProp) {
    errors.push('Missing "adalo" property in package.json.')
  } else {
    // validate library has a logo property
    if (!opts.ignoreLogo) {
      if (!libraryProp.logo) {
        errors.push('Missing library logo in package.json "adalo" property.')
      } else if (!libraryProp.logo.endsWith('logo.png')) {
        errors.push('Library logo filename should be "logo.png".')
      } else if (!fs.existsSync(libraryProp.logo)) {
        errors.push(`Library logo path is invalid or logo doesn't exist`)
      }
    }

    if (libraryProp.iosInstallScript) {
      if (!fs.existsSync(libraryProp.iosInstallScript)) {
        errors.push(
          `Could not find "iosInstallScript" from ${libraryProp.iosInstallScript}.`
        )
      }
    }

    if (libraryProp.androidInstallScript) {
      if (!fs.existsSync(libraryProp.androidInstallScript)) {
        errors.push(
          `Could not find "androidInstallScript" from ${libraryProp.androidInstallScript}.`
        )
      }
    }

    if (libraryProp.webpackConfig) {
      if (!fs.existsSync(libraryProp.webpackConfig)) {
        errors.push(
          `Could not find "webpackConfig" from ${libraryProp.webpackConfig}.`
        )
      }
    }
  }

  if (errors.length > 0) {
    const text =
      errors.length === 1
        ? 'There is an error in your package.json:'
        : 'There are errors in your package.json:'

    console.error('')
    console.error(chalk.bold.red(`  ${text}`))
    console.error('')
    errors.forEach((err) => {
      console.error(`  - ${err}`)
    })
    console.error('')
    process.exit(1)
  }

  return true
}

module.exports = {
  bytesToSize,
  formatName,
  validatePackage,
}
